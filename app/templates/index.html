<!DOCTYPE html>
<html>
<head>
    <title>AnyDataset Converter</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        h1 { color: #333; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; box-sizing: border-box; }
        .checkbox-group { display: flex; align-items: center; }
        .checkbox-group input[type="checkbox"] { width: auto; margin-right: 10px; }
        .checkbox-group label { display: inline; font-weight: normal; }
        button { background: #4CAF50; color: white; padding: 10px 15px; border: none; cursor: pointer; }
        .status { margin-top: 20px; padding: 15px; background: #f1f1f1; display: none; }
        .jobs { margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 8px; border-bottom: 1px solid #ddd; }
        th { background-color: #f2f2f2; }
        .container { display: flex; }
        .left-panel { flex: 2; margin-right: 20px; }
        .right-panel { flex: 1; }
        .file-option { padding: 10px; margin-bottom: 10px; background: #f9f9f9; border-radius: 5px; cursor: pointer; }
        .file-option:hover { background: #e9e9e9; }
        .hidden { display: none; }
        .tabs { display: flex; margin-bottom: 20px; }
        .tab { padding: 10px 15px; cursor: pointer; border: 1px solid #ddd; border-bottom: none; }
        .tab.active { background: #f1f1f1; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .progress-container { margin-top: 15px; width: 100%; background-color: #f1f1f1; border-radius: 5px; }
        .progress-bar { height: 20px; background-color: #4CAF50; width: 0%; border-radius: 5px; text-align: center; line-height: 20px; color: white; transition: width 0.3s; }
        .collapsible { background-color: #f1f1f1; color: #333; cursor: pointer; padding: 10px; width: 100%; border: none; text-align: left; outline: none; margin-bottom: 10px; }
        .collapsible:hover { background-color: #ddd; }
        .collapsible-content { padding: 0 18px; max-height: 0; overflow: hidden; transition: max-height 0.2s ease-out; }
        .expand-arrow { float: right; }
        .advanced-options { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>AnyDataset Converter</h1>
    
    <div class="tabs">
        <div class="tab active" data-tab="file-upload">Single File</div>
        <div class="tab" data-tab="article-processing">Articles</div>
        <div class="tab" data-tab="multi-files">Batch Processing</div>
    </div>
    
    <div style="margin-bottom: 20px; background-color: #e3f2fd; padding: 10px; border-radius: 5px;">
        <p><strong>New interfaces available:</strong></p>
        <p>
            <a href="/process" style="display: inline-block; margin-right: 15px; padding: 8px 15px; background: #2196F3; color: white; text-decoration: none; border-radius: 3px;">New Process File Interface</a>
            <a href="/batch" style="display: inline-block; padding: 8px 15px; background: #4CAF50; color: white; text-decoration: none; border-radius: 3px;">New Batch Processing Interface</a>
        </p>
    </div>
    
    <div class="tab-content active" id="file-upload">
        <div class="container">
            <div class="left-panel">
                <h2>Upload and Convert</h2>
                <div class="form-group">
                    <label for="file">Select File</label>
                    <input type="file" id="file" name="file">
                </div>
                
                <div class="form-group">
                    <label for="conversion-type">Conversion Type</label>
                    <select id="conversion-type" name="conversion-type">
                        <option value="standard">Standard (Instruction-Output)</option>
                        <option value="articles">Articles (Q&A Generation)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="model-provider">Model Provider</label>
                    <select id="model-provider" name="model-provider">
                        <option value="anthropic">Claude (Anthropic)</option>
                        <option value="openai">OpenAI</option>
                        <option value="deepseek">DeepSeek</option>
                        <option value="qwen">Qwen</option>
                        <option value="mistral">Mistral AI</option>
                        <option value="lmstudio">LM Studio (local)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="model-name">Model</label>
                    <select id="model-name" name="model-name"></select>
                </div>
                
                <div id="lmstudio-settings" style="display: none;">
                    <div class="form-group">
                        <label for="base-url">LM Studio URL</label>
                        <input type="text" id="base-url" name="base-url" value="http://localhost:1234">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="api-key">API Key (Optional, will use env value if not provided)</label>
                    <input type="password" id="api-key" name="api-key" placeholder="Enter API key (optional)">
                </div>
                
                <button class="collapsible">Advanced Options <span class="expand-arrow">▼</span></button>
                <div class="collapsible-content">
                    <div class="advanced-options">
                        <div class="form-group">
                            <label for="max-chunks">Max Chunks (0 for unlimited)</label>
                            <input type="number" id="max-chunks" name="max-chunks" value="0" min="0">
                        </div>
                        
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="anonymize" name="anonymize">
                            <label for="anonymize">Anonymize Personal Information</label>
                        </div>
                        
                        <div class="form-group">
                            <label for="train-split">Train Split (0.0 - 1.0)</label>
                            <input type="number" id="train-split" name="train-split" value="0.8" min="0" max="1" step="0.1">
                        </div>
                        
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="keyword-extraction" name="keyword-extraction">
                            <label for="keyword-extraction">Extract Keywords</label>
                        </div>
                        
                        <div class="form-group">
                            <label for="chunk-size">Chunk Size (characters)</label>
                            <input type="number" id="chunk-size" name="chunk-size" value="2000" min="100">
                        </div>
                        
                        <div class="form-group">
                            <label for="overlap-size">Chunk Overlap (characters)</label>
                            <input type="number" id="overlap-size" name="overlap-size" value="200" min="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="system-prompt">System Prompt (Optional)</label>
                            <textarea id="system-prompt" name="system-prompt" rows="3" placeholder="Enter system prompt"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="user-prompt">User Prompt Template (Optional)</label>
                            <textarea id="user-prompt" name="user-prompt" rows="3" placeholder="Enter user prompt template with {text} placeholder"></textarea>
                        </div>
                    </div>
                </div>
                
                <button id="submit">Convert</button>
                
                <div id="status" class="status">
                    <h3>Conversion Status: <span id="status-text">Initializing...</span></h3>
                    <div class="progress-container">
                        <div id="progress-bar" class="progress-bar">0%</div>
                    </div>
                    <div id="download-container" style="display: none; margin-top: 15px;">
                        <button id="download-jsonl">Download JSONL</button>
                        <button id="download-zip">Download ZIP</button>
                    </div>
                </div>
            </div>
            
            <div class="right-panel">
                <h2>Existing Datasets</h2>
                <div id="jobs-list" class="jobs">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Files</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="jobs-table-body">
                            <!-- Jobs will be filled in dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tab-content" id="article-processing">
        <h2>Article Processing</h2>
        <div class="form-group">
            <label for="article-text">Enter Article Text</label>
            <textarea id="article-text" name="article-text" rows="10" placeholder="Paste article content here..."></textarea>
        </div>
        
        <div class="form-group">
            <label for="article-model">Model</label>
            <select id="article-model" name="article-model">
                <option value="anthropic:claude-3-opus-20240229">Claude 3 Opus</option>
                <option value="openai:gpt-4o">GPT-4o</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="questions-count">Number of Questions</label>
            <input type="number" id="questions-count" name="questions-count" value="5" min="1" max="20">
        </div>
        
        <button id="process-article">Process Article</button>
        
        <div id="article-result" class="status">
            <h3>Processing Status: <span id="article-status-text">Initializing...</span></h3>
            <div class="progress-container">
                <div id="article-progress-bar" class="progress-bar">0%</div>
            </div>
            <div id="article-output" style="margin-top: 15px; white-space: pre-wrap;"></div>
            <div id="article-download-container" style="display: none; margin-top: 15px;">
                <button id="download-article-jsonl">Download JSONL</button>
            </div>
        </div>
    </div>
    
    <div class="tab-content" id="multi-files">
        <h2>Batch Processing</h2>
        <div id="selected-files-container">
            <h3>Selected Files</h3>
            <div id="selected-files"></div>
        </div>
        
        <div class="form-group">
            <label for="file-batch">Select Files</label>
            <input type="file" id="file-batch" name="file-batch" multiple>
        </div>
        
        <div class="form-group">
            <label for="batch-conversion-type">Conversion Type</label>
            <select id="batch-conversion-type" name="batch-conversion-type">
                <option value="standard">Standard (Instruction-Output)</option>
                <option value="articles">Articles (Q&A Generation)</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="batch-model-provider">Model Provider</label>
            <select id="batch-model-provider" name="batch-model-provider">
                <option value="anthropic">Claude (Anthropic)</option>
                <option value="openai">OpenAI</option>
                <option value="deepseek">DeepSeek</option>
                <option value="qwen">Qwen</option>
                <option value="mistral">Mistral AI</option>
                <option value="lmstudio">LM Studio (local)</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="batch-model-name">Model</label>
            <select id="batch-model-name" name="batch-model-name"></select>
        </div>
        
        <div id="batch-lmstudio-settings" style="display: none;">
            <div class="form-group">
                <label for="batch-base-url">LM Studio URL</label>
                <input type="text" id="batch-base-url" name="batch-base-url" value="http://localhost:1234">
            </div>
        </div>
        
        <div class="form-group">
            <label for="batch-api-key">API Key (Optional, will use env value if not provided)</label>
            <input type="password" id="batch-api-key" name="batch-api-key" placeholder="Enter API key (optional)">
        </div>
        
        <div class="form-group">
            <label for="max-concurrent">Maximum Concurrent Files</label>
            <input type="number" id="max-concurrent" name="max-concurrent" value="3" min="1" max="10">
        </div>
        
        <button class="collapsible">Advanced Batch Options <span class="expand-arrow">▼</span></button>
        <div class="collapsible-content">
            <div class="advanced-options">
                <div class="form-group">
                    <label for="batch-max-chunks">Max Chunks per File (0 for unlimited)</label>
                    <input type="number" id="batch-max-chunks" name="batch-max-chunks" value="0" min="0">
                </div>
                
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="batch-anonymize" name="batch-anonymize">
                    <label for="batch-anonymize">Anonymize Personal Information</label>
                </div>
                
                <div class="form-group">
                    <label for="batch-train-split">Train Split (0.0 - 1.0)</label>
                    <input type="number" id="batch-train-split" name="batch-train-split" value="0.8" min="0" max="1" step="0.1">
                </div>
                
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="batch-keyword-extraction" name="batch-keyword-extraction">
                    <label for="batch-keyword-extraction">Extract Keywords</label>
                </div>
                
                <div class="form-group">
                    <label for="batch-chunk-size">Chunk Size (characters)</label>
                    <input type="number" id="batch-chunk-size" name="batch-chunk-size" value="2000" min="100">
                </div>
                
                <div class="form-group">
                    <label for="batch-overlap-size">Chunk Overlap (characters)</label>
                    <input type="number" id="batch-overlap-size" name="batch-overlap-size" value="200" min="0">
                </div>
                
                <div class="form-group">
                    <label for="batch-system-prompt">System Prompt (Optional)</label>
                    <textarea id="batch-system-prompt" name="batch-system-prompt" rows="3" placeholder="Enter system prompt"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="batch-user-prompt">User Prompt Template (Optional)</label>
                    <textarea id="batch-user-prompt" name="batch-user-prompt" rows="3" placeholder="Enter user prompt template with {text} placeholder"></textarea>
                </div>
            </div>
        </div>
        
        <button id="batch-submit">Process Batch</button>
        
        <div id="batch-status" class="status">
            <h3>Batch Status: <span id="batch-status-text">Initializing...</span></h3>
            <div class="progress-container">
                <div id="batch-progress-bar" class="progress-bar">0%</div>
            </div>
            <div id="batch-files-progress">
                <p>Processing file: <span id="current-file">-</span></p>
                <p>Completed: <span id="completed-files">0</span> / <span id="total-files">0</span></p>
            </div>
            <div id="batch-download-container" style="display: none; margin-top: 15px;">
                <button id="download-batch-zip">Download Batch ZIP</button>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get elements
            const fileUploadTab = document.querySelector('[data-tab="file-upload"]');
            const articleProcessingTab = document.querySelector('[data-tab="article-processing"]');
            const multiFilesTab = document.querySelector('[data-tab="multi-files"]');
            
            const fileUploadContent = document.getElementById('file-upload');
            const articleProcessingContent = document.getElementById('article-processing');
            const multiFilesContent = document.getElementById('multi-files');
            
            const statusDiv = document.getElementById('status');
            const statusText = document.getElementById('status-text');
            const progressBar = document.getElementById('progress-bar');
            const downloadContainer = document.getElementById('download-container');
            
            const batchStatusDiv = document.getElementById('batch-status');
            const batchStatusText = document.getElementById('batch-status-text');
            const batchProgressBar = document.getElementById('batch-progress-bar');
            const batchDownloadContainer = document.getElementById('batch-download-container');
            
            const articleResultDiv = document.getElementById('article-result');
            const articleStatusText = document.getElementById('article-status-text');
            const articleProgressBar = document.getElementById('article-progress-bar');
            const articleOutput = document.getElementById('article-output');
            const articleDownloadContainer = document.getElementById('article-download-container');
            
            const lmStudioSettings = document.getElementById('lmstudio-settings');
            const batchLmStudioSettings = document.getElementById('batch-lmstudio-settings');
            
            let currentJobId = null;
            let currentBatchJobId = null;
            let currentArticleJobId = null;
            let socket = null;
            
            // Tab navigation
            function showTab(tabId) {
                // Hide all tabs
                fileUploadContent.classList.remove('active');
                articleProcessingContent.classList.remove('active');
                multiFilesContent.classList.remove('active');
                
                fileUploadTab.classList.remove('active');
                articleProcessingTab.classList.remove('active');
                multiFilesTab.classList.remove('active');
                
                // Show selected tab
                document.getElementById(tabId).classList.add('active');
                document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            }
            
            fileUploadTab.addEventListener('click', () => showTab('file-upload'));
            articleProcessingTab.addEventListener('click', () => showTab('article-processing'));
            multiFilesTab.addEventListener('click', () => showTab('multi-files'));
            
            // Load jobs on startup
            loadJobs();
            
            // Collapsible sections
            document.querySelectorAll('.collapsible').forEach(function(collapsible) {
                collapsible.addEventListener('click', function() {
                    this.classList.toggle('active');
                    const content = this.nextElementSibling;
                    const arrow = this.querySelector('.expand-arrow');
                    
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                        arrow.textContent = '▼';
                    } else {
                        content.style.maxHeight = content.scrollHeight + 'px';
                        arrow.textContent = '▲';
                    }
                });
            });
            
            // Model provider change handling
            document.getElementById('model-provider').addEventListener('change', function() {
                const provider = this.value;
                const modelSelect = document.getElementById('model-name');
                
                // Show/hide LM Studio settings
                if (provider === 'lmstudio') {
                    lmStudioSettings.style.display = 'block';
                } else {
                    lmStudioSettings.style.display = 'none';
                }
                
                // Update model options
                updateModelOptions(provider, modelSelect);
            });
            
            // Batch model provider change handling
            document.getElementById('batch-model-provider').addEventListener('change', function() {
                const provider = this.value;
                const modelSelect = document.getElementById('batch-model-name');
                
                // Show/hide LM Studio settings
                if (provider === 'lmstudio') {
                    batchLmStudioSettings.style.display = 'block';
                } else {
                    batchLmStudioSettings.style.display = 'none';
                }
                
                // Update model options
                updateModelOptions(provider, modelSelect);
            });
            
            // Set default provider if available from data attribute
            const providerSelect = document.getElementById('model-provider');
            const batchProviderSelect = document.getElementById('batch-model-provider');
            
            if (providerSelect.dataset.default) {
                const defaultProvider = providerSelect.dataset.default;
                providerSelect.value = defaultProvider;
                batchProviderSelect.value = defaultProvider;
                
                // Show/hide LM Studio settings based on default
                if (defaultProvider === 'lmstudio') {
                    lmStudioSettings.style.display = 'block';
                    batchLmStudioSettings.style.display = 'block';
                }
            }
            
            // Initialize model options
            updateModelOptions(providerSelect.value, document.getElementById('model-name'));
            updateModelOptions(batchProviderSelect.value, document.getElementById('batch-model-name'));
            
            function updateModelOptions(provider, selectElement) {
                // Clear current options
                selectElement.innerHTML = '';
                
                // Get models for selected provider
                // This object will be dynamically replaced by the server when the page loads
                const availableModels = {
                    "anthropic": [
                        "claude-3-5-sonnet-20240620",
                        "claude-3-opus-20240229",
                        "claude-3-sonnet-20240229",
                        "claude-3-haiku-20240307"
                    ],
                    "openai": [
                        "gpt-4o",
                        "gpt-4-turbo",
                        "gpt-4",
                        "gpt-3.5-turbo"
                    ],
                    "deepseek": [
                        "deepseek-reasoner",
                        "deepseek-coder",
                        "deepseek-chat"
                    ],
                    "qwen": [
                        "qwen-max",
                        "qwen-max-0428",
                        "qwen-plus"
                    ],
                    "mistral": [
                        "mistral-large-latest",
                        "mistral-medium-latest",
                        "mistral-small-latest"
                    ],
                    "lmstudio": [
                        "local-model"
                    ]
                };
                
                // Add model options
                const models = availableModels[provider] || [];
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    selectElement.appendChild(option);
                });
            }
            
            // Parse keywords
            function parseKeywords(inputValue) {
                if (!inputValue) return null;
                if (inputValue.trim().toUpperCase() === 'AUTO') {
                    return ['AUTO'];
                }
                return inputValue.split(',').map(k => k.trim()).filter(k => k);
            }
            
            // Single file conversion form submission
            document.getElementById('submit').addEventListener('click', async function() {
                const fileInput = document.getElementById('file');
                if (!fileInput.files.length) {
                    alert('Please select a file to upload');
                    return;
                }
                
                // First upload the file
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                
                try {
                    statusDiv.style.display = 'block';
                    statusText.textContent = 'Uploading file...';
                    progressBar.style.width = '0%';
                    progressBar.textContent = '0%';
                    downloadContainer.style.display = 'none';
                    
                    const uploadResponse = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!uploadResponse.ok) {
                        const errorData = await uploadResponse.json();
                        throw new Error(errorData.detail || 'Error uploading file');
                    }
                    
                    const uploadData = await uploadResponse.json();
                    const filePath = uploadData.file_path;
                    
                    // Now convert the file
                    statusText.textContent = 'Starting conversion...';
                    
                    const conversionFormData = new FormData();
                    conversionFormData.append('file_path', filePath);
                    conversionFormData.append('conversion_type', document.getElementById('conversion-type').value);
                    conversionFormData.append('model_provider', document.getElementById('model-provider').value);
                    conversionFormData.append('model_name', document.getElementById('model-name').value);
                    conversionFormData.append('max_chunks', document.getElementById('max-chunks').value);
                    conversionFormData.append('anonymize', document.getElementById('anonymize').checked);
                    conversionFormData.append('train_split', document.getElementById('train-split').value);
                    conversionFormData.append('keyword_extraction', document.getElementById('keyword-extraction').checked);
                    conversionFormData.append('chunk_size', document.getElementById('chunk-size').value);
                    conversionFormData.append('overlap_size', document.getElementById('overlap-size').value);
                    conversionFormData.append('api_key', document.getElementById('api-key').value);
                    
                    if (document.getElementById('model-provider').value === 'lmstudio') {
                        conversionFormData.append('base_url', document.getElementById('base-url').value);
                    }
                    
                    const systemPrompt = document.getElementById('system-prompt').value;
                    if (systemPrompt) {
                        conversionFormData.append('system_prompt', systemPrompt);
                    }
                    
                    const userPrompt = document.getElementById('user-prompt').value;
                    if (userPrompt) {
                        conversionFormData.append('user_prompt', userPrompt);
                    }
                    
                    const conversionResponse = await fetch('/convert', {
                        method: 'POST',
                        body: conversionFormData
                    });
                    
                    if (!conversionResponse.ok) {
                        const errorData = await conversionResponse.json();
                        throw new Error(errorData.detail || 'Error starting conversion');
                    }
                    
                    const conversionData = await conversionResponse.json();
                    currentJobId = conversionData.job_id;
                    
                    // Connect to WebSocket for real-time updates
                    connectWebSocket(currentJobId);
                    
                    // Start polling for progress
                    pollProgress(currentJobId);
                    
                } catch (error) {
                    statusText.textContent = `Error: ${error.message}`;
                    console.error('Error:', error);
                }
            });
            
            // Batch processing form submission
            document.getElementById('batch-submit').addEventListener('click', async function() {
                const fileInput = document.getElementById('file-batch');
                if (!fileInput.files.length) {
                    alert('Please select files to upload');
                    return;
                }
                
                const files = Array.from(fileInput.files);
                const uploadPromises = files.map(file => {
                    const formData = new FormData();
                    formData.append('file', file);
                    return fetch('/upload', {
                        method: 'POST',
                        body: formData
                    }).then(response => {
                        if (!response.ok) {
                            throw new Error(`Error uploading ${file.name}`);
                        }
                        return response.json();
                    });
                });
                
                try {
                    batchStatusDiv.style.display = 'block';
                    batchStatusText.textContent = 'Uploading files...';
                    batchProgressBar.style.width = '0%';
                    batchProgressBar.textContent = '0%';
                    batchDownloadContainer.style.display = 'none';
                    document.getElementById('current-file').textContent = '-';
                    document.getElementById('completed-files').textContent = '0';
                    document.getElementById('total-files').textContent = files.length;
                    
                    const uploadResults = await Promise.all(uploadPromises);
                    const filePaths = uploadResults.map(result => result.file_path);
                    
                    // Now start batch conversion
                    batchStatusText.textContent = 'Starting batch conversion...';
                    
                    const batchFormData = new FormData();
                    batchFormData.append('file_paths', JSON.stringify(filePaths));
                    batchFormData.append('conversion_type', document.getElementById('batch-conversion-type').value);
                    batchFormData.append('model_provider', document.getElementById('batch-model-provider').value);
                    batchFormData.append('model_name', document.getElementById('batch-model-name').value);
                    batchFormData.append('max_chunks', document.getElementById('batch-max-chunks').value);
                    batchFormData.append('anonymize', document.getElementById('batch-anonymize').checked);
                    batchFormData.append('train_split', document.getElementById('batch-train-split').value);
                    batchFormData.append('keyword_extraction', document.getElementById('batch-keyword-extraction').checked);
                    batchFormData.append('chunk_size', document.getElementById('batch-chunk-size').value);
                    batchFormData.append('overlap_size', document.getElementById('batch-overlap-size').value);
                    batchFormData.append('max_concurrent', document.getElementById('max-concurrent').value);
                    batchFormData.append('api_key', document.getElementById('batch-api-key').value);
                    
                    if (document.getElementById('batch-model-provider').value === 'lmstudio') {
                        batchFormData.append('base_url', document.getElementById('batch-base-url').value);
                    }
                    
                    const systemPrompt = document.getElementById('batch-system-prompt').value;
                    if (systemPrompt) {
                        batchFormData.append('system_prompt', systemPrompt);
                    }
                    
                    const userPrompt = document.getElementById('batch-user-prompt').value;
                    if (userPrompt) {
                        batchFormData.append('user_prompt', userPrompt);
                    }
                    
                    const batchResponse = await fetch('/batch-convert', {
                        method: 'POST',
                        body: batchFormData
                    });
                    
                    if (!batchResponse.ok) {
                        const errorData = await batchResponse.json();
                        throw new Error(errorData.detail || 'Error starting batch conversion');
                    }
                    
                    const batchData = await batchResponse.json();
                    currentBatchJobId = batchData.job_id;
                    
                    // Connect to WebSocket for real-time updates
                    connectWebSocket(currentBatchJobId);
                    
                    // Start polling for progress
                    pollBatchProgress(currentBatchJobId);
                    
                } catch (error) {
                    batchStatusText.textContent = `Error: ${error.message}`;
                    console.error('Error:', error);
                }
            });
            
            // Article processing form submission
            document.getElementById('process-article').addEventListener('click', async function() {
                const articleText = document.getElementById('article-text').value;
                if (!articleText) {
                    alert('Please enter article text');
                    return;
                }
                
                try {
                    articleResultDiv.style.display = 'block';
                    articleStatusText.textContent = 'Processing article...';
                    articleProgressBar.style.width = '0%';
                    articleProgressBar.textContent = '0%';
                    articleOutput.textContent = '';
                    articleDownloadContainer.style.display = 'none';
                    
                    // Create temp file with article content
                    const tempFormData = new FormData();
                    const articleBlob = new Blob([articleText], { type: 'text/plain' });
                    const articleFile = new File([articleBlob], 'article.txt', { type: 'text/plain' });
                    tempFormData.append('file', articleFile);
                    
                    const uploadResponse = await fetch('/upload', {
                        method: 'POST',
                        body: tempFormData
                    });
                    
                    if (!uploadResponse.ok) {
                        const errorData = await uploadResponse.json();
                        throw new Error(errorData.detail || 'Error saving article text');
                    }
                    
                    const uploadData = await uploadResponse.json();
                    const filePath = uploadData.file_path;
                    
                    // Process article
                    const [provider, model] = document.getElementById('article-model').value.split(':');
                    const questionCount = document.getElementById('questions-count').value;
                    
                    const articleFormData = new FormData();
                    articleFormData.append('file_path', filePath);
                    articleFormData.append('conversion_type', 'articles');
                    articleFormData.append('model_provider', provider);
                    articleFormData.append('model_name', model);
                    articleFormData.append('max_chunks', '0');
                    articleFormData.append('anonymize', 'false');
                    articleFormData.append('train_split', '0.8');
                    articleFormData.append('keyword_extraction', 'true');
                    articleFormData.append('chunk_size', '2000');
                    articleFormData.append('overlap_size', '200');
                    
                    // Add article-specific options
                    const additionalOptions = {
                        questions_count: parseInt(questionCount)
                    };
                    articleFormData.append('additional_options_json', JSON.stringify(additionalOptions));
                    
                    const articleResponse = await fetch('/convert', {
                        method: 'POST',
                        body: articleFormData
                    });
                    
                    if (!articleResponse.ok) {
                        const errorData = await articleResponse.json();
                        throw new Error(errorData.detail || 'Error processing article');
                    }
                    
                    const articleData = await articleResponse.json();
                    currentArticleJobId = articleData.job_id;
                    
                    // Connect to WebSocket for real-time updates
                    connectWebSocket(currentArticleJobId);
                    
                    // Start polling for progress
                    pollArticleProgress(currentArticleJobId);
                    
                } catch (error) {
                    articleStatusText.textContent = `Error: ${error.message}`;
                    console.error('Error:', error);
                }
            });
            
            // WebSocket connection
            function connectWebSocket(jobId) {
                // Close existing connection if any
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.close();
                }
                
                // Create new connection
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/${jobId}`;
                socket = new WebSocket(wsUrl);
                
                socket.onopen = function() {
                    console.log('WebSocket connected for job:', jobId);
                };
                
                socket.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    updateProgress(jobId, data);
                };
                
                socket.onerror = function(error) {
                    console.error('WebSocket error:', error);
                };
                
                socket.onclose = function() {
                    console.log('WebSocket disconnected');
                };
            }
            
            // Poll progress of conversion
            function pollProgress(jobId) {
                fetch(`/progress/${jobId}`)
                    .then(response => response.json())
                    .then(data => {
                        updateProgress(jobId, data);
                        
                        // Continue polling if not completed
                        if (!data.completed && data.status !== 'error') {
                            setTimeout(() => pollProgress(jobId), 2000);
                        }
                    })
                    .catch(error => {
                        console.error('Error polling progress:', error);
                        setTimeout(() => pollProgress(jobId), 5000);
                    });
            }
            
            // Poll progress of batch conversion
            function pollBatchProgress(jobId) {
                fetch(`/progress/${jobId}`)
                    .then(response => response.json())
                    .then(data => {
                        updateBatchProgress(jobId, data);
                        
                        // Continue polling if not completed
                        if (!data.completed && data.status !== 'error') {
                            setTimeout(() => pollBatchProgress(jobId), 2000);
                        }
                    })
                    .catch(error => {
                        console.error('Error polling batch progress:', error);
                        setTimeout(() => pollBatchProgress(jobId), 5000);
                    });
            }
            
            // Poll progress of article processing
            function pollArticleProgress(jobId) {
                fetch(`/progress/${jobId}`)
                    .then(response => response.json())
                    .then(data => {
                        updateArticleProgress(jobId, data);
                        
                        // Continue polling if not completed
                        if (!data.completed && data.status !== 'error') {
                            setTimeout(() => pollArticleProgress(jobId), 2000);
                        }
                    })
                    .catch(error => {
                        console.error('Error polling article progress:', error);
                        setTimeout(() => pollArticleProgress(jobId), 5000);
                    });
            }
            
            // Update progress for single file conversion
            function updateProgress(jobId, data) {
                if (jobId !== currentJobId) return;
                
                statusText.textContent = data.message || `Status: ${data.status}`;
                progressBar.style.width = `${data.progress || 0}%`;
                progressBar.textContent = `${data.progress || 0}%`;
                
                if (data.completed) {
                    statusText.textContent = 'Conversion completed successfully!';
                    downloadContainer.style.display = 'block';
                    loadJobs(); // Refresh jobs list
                } else if (data.status === 'error') {
                    statusText.textContent = `Error: ${data.message}`;
                }
            }
            
            // Update progress for batch conversion
            function updateBatchProgress(jobId, data) {
                if (jobId !== currentBatchJobId) return;
                
                batchStatusText.textContent = data.message || `Status: ${data.status}`;
                batchProgressBar.style.width = `${data.progress || 0}%`;
                batchProgressBar.textContent = `${data.progress || 0}%`;
                
                if (data.current_file) {
                    document.getElementById('current-file').textContent = data.current_file;
                }
                
                if (data.completed_files !== undefined) {
                    document.getElementById('completed-files').textContent = data.completed_files;
                }
                
                if (data.total_files !== undefined) {
                    document.getElementById('total-files').textContent = data.total_files;
                }
                
                if (data.completed) {
                    if (data.status === 'completed_with_errors') {
                        batchStatusText.textContent = `Completed with ${data.failed_files} failed conversions.`;
                    } else {
                        batchStatusText.textContent = 'Batch processing completed successfully!';
                    }
                    batchDownloadContainer.style.display = 'block';
                    loadJobs(); // Refresh jobs list
                } else if (data.status === 'error') {
                    batchStatusText.textContent = `Error: ${data.message}`;
                }
            }
            
            // Update progress for article processing
            function updateArticleProgress(jobId, data) {
                if (jobId !== currentArticleJobId) return;
                
                articleStatusText.textContent = data.message || `Status: ${data.status}`;
                articleProgressBar.style.width = `${data.progress || 0}%`;
                articleProgressBar.textContent = `${data.progress || 0}%`;
                
                if (data.completed) {
                    articleStatusText.textContent = 'Article processing completed!';
                    
                    if (data.result && data.result.questions) {
                        let output = 'Generated Q&A Pairs:\n\n';
                        data.result.questions.forEach((qa, index) => {
                            output += `Q${index+1}: ${qa.question}\n`;
                            output += `A${index+1}: ${qa.answer}\n\n`;
                        });
                        articleOutput.textContent = output;
                    }
                    
                    articleDownloadContainer.style.display = 'block';
                    loadJobs(); // Refresh jobs list
                } else if (data.status === 'error') {
                    articleStatusText.textContent = `Error: ${data.message}`;
                }
            }
            
            // Download buttons
            document.getElementById('download-jsonl').addEventListener('click', function() {
                if (currentJobId) {
                    window.location.href = `/download/${currentJobId}?format=jsonl`;
                }
            });
            
            document.getElementById('download-zip').addEventListener('click', function() {
                if (currentJobId) {
                    window.location.href = `/download/${currentJobId}?format=zip`;
                }
            });
            
            document.getElementById('download-batch-zip').addEventListener('click', function() {
                if (currentBatchJobId) {
                    window.location.href = `/download/${currentBatchJobId}?format=zip`;
                }
            });
            
            document.getElementById('download-article-jsonl').addEventListener('click', function() {
                if (currentArticleJobId) {
                    window.location.href = `/download/${currentArticleJobId}?format=jsonl`;
                }
            });
            
            // Load existing jobs
            function loadJobs() {
                fetch('/jobs')
                    .then(response => response.json())
                    .then(jobs => {
                        const tableBody = document.getElementById('jobs-table-body');
                        tableBody.innerHTML = '';
                        
                        if (jobs.length === 0) {
                            const row = document.createElement('tr');
                            row.innerHTML = '<td colspan="3">No datasets available</td>';
                            tableBody.appendChild(row);
                            return;
                        }
                        
                        jobs.forEach(job => {
                            const row = document.createElement('tr');
                            
                            let name = job.name;
                            if (job.is_batch) {
                                name = `${name} (Batch)`;
                            }
                            
                            let filesInfo = '';
                            if (job.completed) {
                                filesInfo = `Train: ${job.train_count}, Valid: ${job.valid_count}`;
                            } else {
                                filesInfo = 'Processing...';
                            }
                            
                            let actions = '';
                            if (job.completed) {
                                actions = `
                                    <button onclick="window.location.href='/download/${job.name}?format=jsonl'">JSONL</button>
                                    <button onclick="window.location.href='/download/${job.name}?format=zip'">ZIP</button>
                                `;
                            } else {
                                actions = 'In progress...';
                            }
                            
                            row.innerHTML = `
                                <td>${name}</td>
                                <td>${filesInfo}</td>
                                <td>${actions}</td>
                            `;
                            
                            tableBody.appendChild(row);
                        });
                    })
                    .catch(error => console.error('Error loading jobs:', error));
            }
            
            // Batch file selection display
            const fileBatchInput = document.getElementById('file-batch');
            const selectedFilesDiv = document.getElementById('selected-files');
            
            fileBatchInput.addEventListener('change', function() {
                selectedFilesDiv.innerHTML = '';
                
                if (this.files.length > 0) {
                    const fileList = document.createElement('ul');
                    fileList.style.padding = '0';
                    fileList.style.margin = '10px 0';
                    fileList.style.listStyle = 'none';
                    
                    Array.from(this.files).forEach(file => {
                        const listItem = document.createElement('li');
                        listItem.textContent = file.name;
                        listItem.style.padding = '5px 10px';
                        listItem.style.margin = '2px 0';
                        listItem.style.backgroundColor = '#f9f9f9';
                        listItem.style.borderRadius = '3px';
                        fileList.appendChild(listItem);
                    });
                    
                    selectedFilesDiv.appendChild(fileList);
                }
            });
        });
    </script>
</body>
</html>